<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        :root {
            --color-primary: #2c2c2c;
            --color-secondary: #8b7355;
            --color-accent: #6b5344;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-text-muted: #999999;
            --color-background: #ffffff;
            --color-background-alt: #fafaf8;
            --color-border: #e8e4de;
            --color-border-light: #f0ece6;
            --color-success: #4a7c59;
            --color-warning: #b8860b;
            --color-error: #8b3a3a;
            --font-heading: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.7;
            font-weight: 400;
            font-size: 15px;
            letter-spacing: 0.02em;
        }

        .header {
            background: var(--color-background);
            color: var(--color-primary);
            padding: 1.5rem 4vw;
            border-bottom: 1px solid var(--color-border);
        }

        .header h1 {
            font-family: var(--font-heading);
            font-size: 1.75rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            color: var(--color-primary);
        }

        .header p {
            color: var(--color-text-light);
            margin-top: 0.15rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 400;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem 4vw;
        }

        .nav {
            margin-bottom: 1rem;
        }

        .nav a {
            color: var(--color-secondary);
            text-decoration: none;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav a:hover {
            color: var(--color-accent);
        }

        .card {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card h2 {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        /* Form Fields */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.35rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            font-size: 0.9rem;
            font-family: var(--font-body);
            transition: border-color 0.2s ease;
            background: var(--color-background);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-secondary);
        }

        /* Required Approvals Section */
        .approvals-intro {
            font-size: 0.85rem;
            color: var(--color-text-light);
            margin-bottom: 1.25rem;
            line-height: 1.5;
        }

        .approval-group {
            border: 1px solid var(--color-border-light);
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--color-background-alt);
        }

        .approval-group:last-child {
            margin-bottom: 0;
        }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .approval-title {
            font-family: var(--font-heading);
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-primary);
        }

        .approval-hint {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            font-style: italic;
        }

        .approval-fields {
            display: grid;
            grid-template-columns: 120px 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        .approval-field {
            display: flex;
            flex-direction: column;
        }

        .approval-field label {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.35rem;
        }

        .approval-field input,
        .approval-field select {
            padding: 0.6rem;
            border: 1px solid var(--color-border);
            font-size: 0.85rem;
            font-family: var(--font-body);
            transition: border-color 0.2s ease;
            background: var(--color-background);
        }

        .approval-field input:focus,
        .approval-field select:focus {
            outline: none;
            border-color: var(--color-secondary);
        }

        .approval-field select[value="no"] {
            border-color: var(--color-error);
        }

        .food-approval,
        .beverage-approval {
            transition: opacity 0.2s ease, max-height 0.3s ease;
        }

        .approval-group.hidden {
            display: none;
        }

        .add-approval-btn {
            background: none;
            border: 1px dashed var(--color-border);
            color: var(--color-text-muted);
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 0.5rem;
        }

        .add-approval-btn:hover {
            border-color: var(--color-secondary);
            color: var(--color-secondary);
        }

        .add-approval-btn.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .approval-fields {
                grid-template-columns: 1fr;
            }

            .approval-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Split View */
        .split-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .split-panel {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .split-panel h3 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--color-primary);
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .panel-subtitle {
            text-align: center;
            color: var(--color-text-muted);
            font-size: 0.7rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Example Format Panel */
        .example-content {
            flex: 1;
            background: var(--color-background-alt);
            border: 1px dashed var(--color-border);
            padding: 1rem;
            text-align: center;
            font-family: Calibri, sans-serif;
            font-size: 10pt;
            line-height: 1.15;
            overflow-y: auto;
            min-height: 350px;
        }

        .example-content p {
            margin: 0;
            padding: 0;
        }

        .example-section-header {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0;
        }

        .example-section-header:first-child {
            margin-top: 0;
        }

        /* Menu Input - Quill Editor */
        .menu-input-container {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
            background: var(--color-background);
            height: 350px;
            min-height: 200px;
            max-height: 800px;
            overflow: hidden;
            resize: vertical;
            position: relative;
        }

        .menu-input-container .ql-toolbar {
            border: none;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-background-alt);
            padding: 0.5rem;
            flex-shrink: 0;
        }

        .menu-input-container .ql-container {
            border: none;
            flex: 1;
            font-family: Calibri, sans-serif;
            font-size: 10pt;
            overflow-y: auto !important;
        }

        .menu-input-container .ql-editor {
            text-align: center;
            padding: 1rem;
            line-height: 1.15;
        }

        .menu-input-container .ql-editor p {
            margin: 0;
            padding: 0;
        }

        .menu-input-container .ql-editor.ql-blank::before {
            text-align: center;
            font-style: normal;
            color: var(--color-text-muted);
        }

        /* Allergens Section */
        .allergens-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
        }

        .allergens-section label {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: block;
            margin-bottom: 0.35rem;
        }

        .allergens-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            font-size: 0.8rem;
            font-family: monospace;
            resize: vertical;
            min-height: 50px;
        }

        .allergens-input:focus {
            outline: none;
            border-color: var(--color-secondary);
        }

        .allergens-hint {
            font-size: 0.65rem;
            color: var(--color-text-muted);
            margin-top: 0.25rem;
        }

        /* Expand Button */
        .expand-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(139, 115, 85, 0.1);
            border: 1px solid var(--color-border);
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            color: var(--color-secondary);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-body);
        }

        .expand-btn:hover {
            background: rgba(139, 115, 85, 0.2);
            border-color: var(--color-secondary);
        }

        .expand-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid;
            cursor: pointer;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            font-family: var(--font-body);
            text-align: center;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-background);
            border-color: var(--color-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: transparent;
            color: var(--color-primary);
        }

        .btn-success {
            background: var(--color-success);
            color: var(--color-background);
            border-color: var(--color-success);
        }

        .btn-success:hover:not(:disabled) {
            background: transparent;
            color: var(--color-success);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-container {
            text-align: center;
            padding: 1rem;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            margin-top: 1rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid;
            font-size: 0.9rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(74, 124, 89, 0.08);
            color: var(--color-success);
            border-color: rgba(74, 124, 89, 0.2);
        }

        .alert-error {
            background: rgba(139, 58, 58, 0.08);
            color: var(--color-error);
            border-color: rgba(139, 58, 58, 0.2);
        }

        .alert-info {
            background: rgba(139, 115, 85, 0.08);
            color: var(--color-secondary);
            border-color: rgba(139, 115, 85, 0.2);
        }

        /* Spinner */
        .spinner {
            border: 2px solid var(--color-border);
            border-top: 2px solid var(--color-secondary);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Step 2 Layout */
        .step2-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .step2-left-panel,
        .step2-right-panel {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        /* Panel Header */
        .panel-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .panel-header h3 {
            margin-bottom: 0.25rem;
        }

        /* Edit Toggle */
        .edit-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .edit-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--color-background-alt);
            border: 1px solid var(--color-border);
            cursor: pointer;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-body);
            transition: all 0.2s;
        }

        .edit-toggle:hover {
            border-color: var(--color-secondary);
        }

        .edit-toggle.active {
            background: var(--color-primary);
            color: var(--color-background);
            border-color: var(--color-primary);
        }

        .edit-mode-notice {
            display: none;
            background: rgba(184, 134, 11, 0.1);
            border: 1px solid rgba(184, 134, 11, 0.2);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: var(--color-warning);
            text-align: center;
        }

        .edit-mode-notice.show {
            display: block;
        }

        /* Reviewed Menu Content Area */
        .reviewed-content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
            background: var(--color-background);
            min-height: 400px;
            max-height: 600px;
        }

        .reviewed-content-area {
            flex: 1;
            padding: 1.5rem;
            font-family: Calibri, sans-serif;
            font-size: 10pt;
            line-height: 1.15;
            text-align: center;
            overflow-y: auto;
            background: var(--color-background);
        }

        .reviewed-content-area p {
            margin: 0;
            padding: 0;
        }

        .reviewed-content-area.editable {
            cursor: text;
            border: 2px solid var(--color-secondary);
        }

        .reviewed-content-area.editable:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.3) inset;
        }

        /* Read-only form fields in step 2 */
        .form-fields-readonly {
            margin-bottom: 1rem;
        }

        .form-fields-readonly .card {
            background: var(--color-background-alt);
        }

        .form-fields-readonly .form-group input,
        .form-fields-readonly .form-group select {
            background: var(--color-background-alt);
            color: var(--color-text);
            cursor: default;
            border-color: var(--color-border-light);
        }

        .form-fields-readonly .form-group input:focus,
        .form-fields-readonly .form-group select:focus {
            border-color: var(--color-border-light);
        }

        /* AI Suggestions Panel */
        .suggestions-list {
            flex: 1;
            background: rgba(184, 134, 11, 0.05);
            border: 1px solid rgba(184, 134, 11, 0.2);
            padding: 1rem;
            overflow-y: auto;
        }

        .suggestion-item {
            background: var(--color-background);
            border-left: 3px solid var(--color-warning);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .suggestion-type {
            font-weight: 600;
            color: var(--color-warning);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.35rem;
        }

        .suggestion-detail {
            color: var(--color-text-light);
            font-size: 0.85rem;
        }

        .suggestion-change {
            font-family: monospace;
            background: rgba(184, 134, 11, 0.1);
            padding: 0.2rem 0.4rem;
            margin: 0.2rem 0;
            display: inline-block;
            font-size: 0.75rem;
        }

        /* Confidence Badges */
        .confidence-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .confidence-high {
            background: rgba(74, 124, 89, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(74, 124, 89, 0.2);
        }

        .confidence-medium {
            background: rgba(184, 134, 11, 0.1);
            color: var(--color-warning);
            border: 1px solid rgba(184, 134, 11, 0.2);
        }

        .confidence-low {
            background: rgba(139, 115, 85, 0.1);
            color: var(--color-secondary);
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        /* Critical Error Styles */
        .suggestion-item.critical-error {
            border-left: 3px solid #c0392b;
            background: rgba(192, 57, 43, 0.06);
        }

        .suggestion-item.critical-error .suggestion-type {
            color: #c0392b;
        }

        .severity-badge-critical {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(192, 57, 43, 0.12);
            color: #c0392b;
            border: 1px solid rgba(192, 57, 43, 0.3);
        }

        .critical-override-btn {
            margin-top: 0.5rem;
            padding: 0.4rem 0.75rem;
            font-size: 0.65rem;
            font-family: var(--font-body);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: transparent;
            color: #c0392b;
            border: 1px solid #c0392b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .critical-override-btn:hover {
            background: rgba(192, 57, 43, 0.08);
        }

        .critical-override-btn.overridden {
            background: rgba(192, 57, 43, 0.05);
            color: var(--color-text-muted);
            border-color: var(--color-border);
        }

        .suggestion-item.critical-error.overridden {
            opacity: 0.5;
            border-left-color: var(--color-border);
            background: var(--color-background-alt);
        }

        .suggestion-item.critical-error.overridden .suggestion-type,
        .suggestion-item.critical-error.overridden .suggestion-detail {
            text-decoration: line-through;
        }

        .critical-error-banner {
            display: none;
            background: rgba(192, 57, 43, 0.08);
            border: 1px solid rgba(192, 57, 43, 0.3);
            color: #c0392b;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .critical-error-banner.show {
            display: block;
        }

        .btn-success.blocked {
            background: var(--color-text-muted);
            border-color: var(--color-text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-success.blocked:hover {
            background: var(--color-text-muted);
            color: var(--color-background);
        }

        /* Re-run AI Check Button */
        .rerun-btn {
            display: none;
            padding: 0.5rem 1rem;
            background: var(--color-background-alt);
            border: 1px solid var(--color-border);
            cursor: pointer;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-body);
            transition: all 0.2s;
        }

        .rerun-btn:hover {
            border-color: var(--color-secondary);
            color: var(--color-secondary);
        }

        .rerun-btn.show {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Corrected text highlighting */
        .ql-editor .corrected,
        .auto-corrected {
            background: rgba(74, 124, 89, 0.15) !important;
        }

        /* Fullscreen Modal */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(44, 44, 44, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }

        .fullscreen-modal.show {
            display: flex;
        }

        .fullscreen-content {
            background: #e5e7eb;
            width: 100%;
            max-width: 1800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-background);
        }

        .fullscreen-header h3 {
            margin: 0;
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--color-primary);
        }

        .fullscreen-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-muted);
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .fullscreen-close:hover {
            color: var(--color-primary);
        }

        .fullscreen-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2.5rem;
            padding: 1.5rem;
            overflow: hidden;
            background: #e5e7eb;
        }

        .fullscreen-page {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 520px;
            min-width: 520px;
            height: calc(100% - 30px);
            padding: 24px 32px 40px 32px;
            font-family: Calibri, sans-serif;
            font-size: 7.5pt;
            line-height: 1.25;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        .fullscreen-page p {
            margin: 0.15rem 0;
        }

        .fullscreen-page-number {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8pt;
            color: var(--color-text-muted);
        }

        .fullscreen-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background: var(--color-background);
        }

        .page-btn {
            background: var(--color-primary);
            color: var(--color-background);
            border: 2px solid var(--color-primary);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: var(--font-body);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: transparent;
            color: var(--color-primary);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-indicator {
            font-size: 0.8rem;
            color: var(--color-text-light);
        }

        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--color-border-light);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background: var(--color-background-alt);
        }

        .autocomplete-item .ac-name {
            color: var(--color-text);
            font-weight: 500;
        }

        .autocomplete-item .ac-detail {
            color: var(--color-text-muted);
            font-size: 0.75rem;
            margin-top: 0.1rem;
        }

        .ac-match {
            font-weight: 700;
            color: var(--color-secondary);
        }

        /* Recent Project Loader */
        .recent-project-loader {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            margin-bottom: 1rem;
            background: var(--color-background-alt);
            border: 1px solid var(--color-border-light);
        }

        .recent-project-loader label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--color-text-muted);
            white-space: nowrap;
        }

        .recent-project-loader select {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border);
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--color-text);
            background: var(--color-background);
        }

        .recent-project-loader select:focus {
            outline: none;
            border-color: var(--color-secondary);
        }

        .submission-mode {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .submission-mode-option {
            border: 1px solid var(--color-border);
            background: var(--color-background-alt);
            padding: 0.75rem 1rem;
            min-width: 280px;
            cursor: pointer;
        }

        .submission-mode-option input {
            margin-right: 0.5rem;
        }

        .modification-search {
            display: none;
            margin-bottom: 1rem;
            border: 1px solid var(--color-border-light);
            background: var(--color-background-alt);
            padding: 0.75rem;
        }

        .modification-search.show {
            display: block;
        }

        .modification-search label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-muted);
        }

        .modification-search input {
            width: 100%;
            padding: 0.6rem 0.7rem;
            border: 1px solid var(--color-border);
            font-family: var(--font-body);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .search-results {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            background: var(--color-background);
        }

        .search-result-item {
            padding: 0.6rem 0.7rem;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
            font-size: 0.82rem;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--color-background-alt);
        }

        .revision-selected {
            display: none;
            margin-bottom: 0.75rem;
            font-size: 0.78rem;
            color: var(--color-success);
        }

        .revision-selected.show {
            display: block;
        }

        .modification-source-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .modification-source-option {
            border: 1px solid var(--color-border);
            background: var(--color-background);
            padding: 0.45rem 0.65rem;
            font-size: 0.78rem;
            cursor: pointer;
        }

        .modification-source-option input {
            margin-right: 0.4rem;
        }

        .modification-source-panel {
            display: none;
        }

        .modification-source-panel.show {
            display: block;
        }

        .baseline-upload-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .baseline-upload-row input[type="file"] {
            flex: 1;
            margin-bottom: 0;
            background: var(--color-background);
            border: 1px solid var(--color-border);
        }

        .baseline-upload-btn {
            border: 1px solid var(--color-border);
            background: var(--color-background);
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 0.78rem;
            padding: 0.55rem 0.8rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .baseline-upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .persistent-preview {
            display: none;
            margin-top: 1rem;
            border: 1px solid var(--color-border);
            background: var(--color-background-alt);
            padding: 0.75rem;
        }

        .persistent-preview.show {
            display: block;
        }

        .persistent-preview h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .persistent-preview-body {
            max-height: 240px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.85rem;
            line-height: 1.4;
            background: var(--color-background);
            padding: 0.75rem;
            border: 1px solid var(--color-border-light);
        }

        .persistent-ins {
            background: rgba(241, 196, 15, 0.25);
        }

        .persistent-del {
            color: #b71c1c;
            text-decoration: line-through;
            background: rgba(183, 28, 28, 0.08);
        }

        .ai-temp-note {
            margin-top: 0.5rem;
            font-size: 0.72rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="padding-top: 0; padding-bottom: 0;">
            <h1>Richard Sandoval Hospitality</h1>
            <p>Submit New Menu</p>
        </div>
    </div>

    <div class="container">
        <div class="nav">
            <a href="/">Back to Dashboard</a>
        </div>

        <div id="alertContainer"></div>

        <!-- Step 1: Form Fields -->
        <div id="step1">
            <div class="card">
                <h2>Submitter Information</h2>
                <div class="form-grid">
                    <div class="form-group autocomplete-wrapper">
                        <label for="submitterName">Your Name *</label>
                        <input type="text" id="submitterName" required placeholder="First and Last Name" autocomplete="off" oninput="onSubmitterNameInput(this.value)">
                        <div class="autocomplete-dropdown" id="submitterDropdown"></div>
                    </div>
                    <div class="form-group">
                        <label for="submitterEmail">Your Email *</label>
                        <input type="email" id="submitterEmail" required placeholder="chef@example.com">
                    </div>
                    <div class="form-group">
                        <label for="submitterJobTitle">Job Title *</label>
                        <input type="text" id="submitterJobTitle" required placeholder="e.g., Executive Chef">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Project Details</h2>
                <div class="submission-mode">
                    <label class="submission-mode-option">
                        <input type="radio" name="submissionMode" id="submissionModeNew" value="new" checked onchange="onSubmissionModeChange()">
                        Brand New Menu Submission
                    </label>
                    <label class="submission-mode-option">
                        <input type="radio" name="submissionMode" id="submissionModeModification" value="modification" onchange="onSubmissionModeChange()">
                        Modification to Existing Menu
                    </label>
                </div>
                <div id="modificationSearchSection" class="modification-search">
                    <div class="modification-source-options">
                        <label class="modification-source-option">
                            <input type="radio" name="modificationSource" id="modSourceDatabase" value="database" checked onchange="onModificationSourceChange()">
                            Find In Database
                        </label>
                        <label class="modification-source-option">
                            <input type="radio" name="modificationSource" id="modSourceUpload" value="upload" onchange="onModificationSourceChange()">
                            Upload Prior Approved DOCX
                        </label>
                    </div>
                    <div id="modSourceDatabasePanel" class="modification-source-panel show">
                        <label for="submissionSearchQuery">Find previous approved submission</label>
                        <input
                            type="text"
                            id="submissionSearchQuery"
                            placeholder="Search by project, property, submitter..."
                            oninput="onSubmissionSearchInput(this.value)"
                        >
                        <div id="submissionSearchResults" class="search-results"></div>
                    </div>
                    <div id="modSourceUploadPanel" class="modification-source-panel">
                        <label for="baselineDocUpload">Upload approved/redlined DOCX received from the team</label>
                        <div class="baseline-upload-row">
                            <input type="file" id="baselineDocUpload" accept=".docx">
                            <button type="button" class="baseline-upload-btn" id="baselineUploadBtn" onclick="uploadBaselineDoc()">Extract Baseline</button>
                        </div>
                    </div>
                    <div id="revisionSelectedNote" class="revision-selected"></div>
                </div>
                <div class="recent-project-loader" id="recentProjectLoader" style="display: none;">
                    <label for="recentProjectSelect">Load from Recent</label>
                    <select id="recentProjectSelect" onchange="loadRecentProject(this.selectedIndex - 1)">
                        <option value="">-- Select a recent project --</option>
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="projectName">Project Name *</label>
                        <input type="text" id="projectName" required placeholder="Enter project name">
                    </div>
                    <div class="form-group">
                        <label for="property">Property *</label>
                        <input type="text" id="property" required placeholder="Enter property name">
                    </div>
                    <div class="form-group">
                        <label for="menuType">Menu Type *</label>
                        <select id="menuType" required>
                            <option value="">Select menu type</option>
                            <option value="standard">Standard Menu</option>
                            <option value="prix_fixe">Prix Fixe / Pre-Fix</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="templateType">Template Type *</label>
                        <select id="templateType" required>
                            <option value="">Select template type</option>
                            <option value="food">Food Menu</option>
                            <option value="beverage">Beverage Menu</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hotelName">Hotel Name</label>
                        <input type="text" id="hotelName" placeholder="Enter hotel name">
                    </div>
                    <div class="form-group">
                        <label for="cityCountry">City / Country *</label>
                        <input type="text" id="cityCountry" required placeholder="e.g., New York, USA">
                    </div>
                    <div class="form-group">
                        <label for="dateNeeded">Date Needed *</label>
                        <input type="date" id="dateNeeded" required>
                    </div>
                    <div class="form-group">
                        <label for="assetType">Asset Type *</label>
                        <select id="assetType" required onchange="toggleAssetFields()">
                            <option value="">Select asset type</option>
                            <option value="PRINT">Print</option>
                            <option value="DIGITAL">Digital</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orientation">Orientation *</label>
                        <select id="orientation" required>
                            <option value="">Select orientation</option>
                            <option value="Portrait">Portrait</option>
                            <option value="Landscape">Landscape</option>
                        </select>
                    </div>
                </div>

                <!-- Print-specific fields -->
                <div id="printFields" class="hidden">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="widthPrint">Width (inches) *</label>
                            <input type="number" id="widthPrint" step="0.01" min="0" placeholder="e.g., 8.5">
                        </div>
                        <div class="form-group">
                            <label for="heightPrint">Height (inches) *</label>
                            <input type="number" id="heightPrint" step="0.01" min="0" placeholder="e.g., 11">
                        </div>
                        <div class="form-group">
                            <label for="cropMarks">Crop Marks *</label>
                            <select id="cropMarks">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bleedMarks">Bleed Marks *</label>
                            <select id="bleedMarks">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fileSizeLimit">File Size Limit *</label>
                            <select id="fileSizeLimit" onchange="toggleFileSizeLimit()">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="fileSizeLimitMbGroup">
                            <label for="fileSizeLimitMb">Max Size (MB) *</label>
                            <input type="number" id="fileSizeLimitMb" step="0.1" min="0" placeholder="e.g., 10">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="fileDeliveryNotes">File Delivery Notes</label>
                        <textarea id="fileDeliveryNotes" rows="2" placeholder="Optional delivery instructions" style="width: 100%; padding: 0.5rem; border: 1px solid var(--color-border); font-family: var(--font-body); font-size: 0.85rem; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Digital-specific fields -->
                <div id="digitalFields" class="hidden">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="widthDigital">Width (pixels) *</label>
                            <input type="number" id="widthDigital" step="1" min="0" placeholder="e.g., 1920">
                        </div>
                        <div class="form-group">
                            <label for="heightDigital">Height (pixels) *</label>
                            <input type="number" id="heightDigital" step="1" min="0" placeholder="e.g., 1080">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Required Approval Section -->
            <div class="card" id="approvalsCard">
                <h2>Required Approval</h2>
                <p class="approvals-intro">Confirm this menu has been reviewed and approved before submission.</p>

                <div class="approval-group">
                    <div class="approval-header">
                        <span class="approval-title">Approver</span>
                        <span class="approval-hint" id="approvalHint">e.g., Property GM, Director of F&B, Executive Chef, Chef de Cuisine</span>
                    </div>
                    <div class="approval-fields">
                        <div class="approval-field">
                            <label>Approved? *</label>
                            <select id="approval1" required>
                                <option value="">Select</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="approval-field">
                            <label>Approver Name *</label>
                            <input type="text" id="approver1Name" required placeholder="First and Last Name">
                        </div>
                        <div class="approval-field">
                            <label>Position *</label>
                            <input type="text" id="approver1Position" required placeholder="e.g., Executive Chef">
                        </div>
                    </div>
                </div>

                <!-- Additional Approval (optional) -->
                <div class="approval-group hidden" id="additionalApprovalGroup">
                    <div class="approval-header">
                        <span class="approval-title">Additional Approver</span>
                        <span class="approval-hint">Optional second approver</span>
                    </div>
                    <div class="approval-fields">
                        <div class="approval-field">
                            <label>Approved?</label>
                            <select id="approval2">
                                <option value="">Select</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="approval-field">
                            <label>Approver Name</label>
                            <input type="text" id="approver2Name" placeholder="First and Last Name">
                        </div>
                        <div class="approval-field">
                            <label>Position</label>
                            <input type="text" id="approver2Position" placeholder="Position">
                        </div>
                    </div>
                </div>

                <button type="button" class="add-approval-btn" id="addApprovalBtn" onclick="toggleAdditionalApproval()">
                    + Add Additional Approver
                </button>
            </div>

            <!-- Split View: Example + Menu Input -->
            <div class="split-container">
                <div class="split-panel">
                    <h3>Example Format</h3>
                    <p class="panel-subtitle">Your menu should follow this centered format</p>
                    <div class="example-content">
                        <p class="example-section-header">For the table</p>
                        <p>Makimono & Dips</p>
                        <p><strong>Smoked swordfish</strong>, smoked mesquite, pickled chili, radish, lemon aioli, cherry tomato, plantain chips</p>
                        <p><strong>Guacamole</strong>, jalapeno, chipotle aioli, lime, chips, add tuna +6</p>
                        <p><strong>Kale Salad</strong>, heirloom cherry tomato, grapes, candied cancha corn, orange-white balsamic vinaigrette *D,V</p>
                        <p>&nbsp;</p>
                        <p class="example-section-header">Entree</p>
                        <p>(select one)</p>
                        <p><strong>Omakase</strong></p>
                        <p><strong>Angry tuna roll</strong>, spicy tuna, avocado, lemon, yuzu kosho aioli*</p>
                        <p><strong>California roll</strong>, salmon, avocado, cucumber*</p>
                        <p><strong>Salmon & Pork Belly Nigiri</strong>, torched, kabayaki G*</p>
                        <p><strong>Prime Beef Nigiri</strong>, truffle honey pearls, chimi-yuzu kosho*</p>
                        <p><strong>Sushi Tamaki Hand Roll</strong>, avocado, cucumber, sriracha aioli, masago, bubu arare VG</p>
                        <p>~</p>
                        <p><strong>Poke Bowl</strong></p>
                        <p>sushi rice, avocado, cucumber, radish, pickled mushroom, edamame, onion, mango, chipotle aioli, ponzu, furikake, tuna or pork belly, add lobster + 8</p>
                        <p>~</p>
                        <p><strong>Hot Stone</strong></p>
                        <p><strong>Casa Style</strong>, served with roasted fajita vegetables, pico de gallo, guacamole, salsa, flour tortillas</p>
                        <p><strong>Provoleta Cheese</strong> D,V</p>
                        <p>&nbsp;</p>
                        <p class="example-section-header">Dessert</p>
                        <p><strong>The Yuzu</strong>, yuzu cheesecake, almond crumble, white chocolate N</p>
                    </div>
                </div>

                <div class="split-panel">
                    <h3>Your Menu Content</h3>
                    <p class="panel-subtitle">Paste your menu here (formatting preserved)</p>
                    <div class="menu-input-container">
                        <div id="menuEditor"></div>
                        <button class="expand-btn" onclick="openFullscreenView()" title="View full menu">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            Full View
                        </button>
                    </div>
                    <div class="allergens-section">
                        <label for="allergensInput">Allergen Key (Optional)</label>
                        <textarea id="allergensInput" class="allergens-input" placeholder="Paste your allergen key here, e.g.: C crustaceans | D dairy | E egg | F fish | G gluten | N nuts | V vegetarian | VG vegan"></textarea>
                        <p class="allergens-hint">If left blank, the default RSH allergen codes will be used for review.</p>
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button id="runCheckBtn" class="btn btn-primary" onclick="runBasicCheck()">
                    Run Basic AI Check
                </button>
            </div>
        </div>

        <!-- Step 2: AI Check Results (Hidden initially) -->
        <div id="step2" class="hidden">
            <!-- Read-only form fields showing what user selected -->
            <div id="step2FormFields" class="form-fields-readonly">
                <div class="card">
                    <h2>Submitter Information <span style="font-size: 0.7rem; font-weight: 400; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.1em;">(Read Only)</span></h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" id="step2SubmitterName" readonly>
                        </div>
                        <div class="form-group">
                            <label>Your Email</label>
                            <input type="text" id="step2SubmitterEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label>Job Title</label>
                            <input type="text" id="step2SubmitterJobTitle" readonly>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Project Details <span style="font-size: 0.7rem; font-weight: 400; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.1em;">(Read Only)</span></h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Name</label>
                            <input type="text" id="step2ProjectName" readonly>
                        </div>
                        <div class="form-group">
                            <label>Property</label>
                            <input type="text" id="step2Property" readonly>
                        </div>
                        <div class="form-group">
                            <label>Menu Type</label>
                            <input type="text" id="step2MenuType" readonly>
                        </div>
                        <div class="form-group">
                            <label>Template Type</label>
                            <input type="text" id="step2TemplateType" readonly>
                        </div>
                        <div class="form-group">
                            <label>Hotel Name</label>
                            <input type="text" id="step2HotelName" readonly>
                        </div>
                        <div class="form-group">
                            <label>City / Country</label>
                            <input type="text" id="step2CityCountry" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date Needed</label>
                            <input type="text" id="step2DateNeeded" readonly>
                        </div>
                        <div class="form-group">
                            <label>Asset Type</label>
                            <input type="text" id="step2AssetType" readonly>
                        </div>
                        <div class="form-group">
                            <label>Orientation</label>
                            <input type="text" id="step2Orientation" readonly>
                        </div>
                        <div class="form-group">
                            <label>Dimensions</label>
                            <input type="text" id="step2Dimensions" readonly>
                        </div>
                        <div class="form-group hidden" id="step2CropMarksGroup">
                            <label>Crop Marks</label>
                            <input type="text" id="step2CropMarks" readonly>
                        </div>
                        <div class="form-group hidden" id="step2BleedMarksGroup">
                            <label>Bleed Marks</label>
                            <input type="text" id="step2BleedMarks" readonly>
                        </div>
                        <div class="form-group hidden" id="step2FileSizeLimitGroup">
                            <label>File Size Limit</label>
                            <input type="text" id="step2FileSizeLimit" readonly>
                        </div>
                        <div class="form-group hidden" id="step2FileDeliveryNotesGroup">
                            <label>Delivery Notes</label>
                            <input type="text" id="step2FileDeliveryNotes" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step2-container">
                <div class="step2-left-panel">
                    <div class="panel-header">
                        <h3>Your Menu</h3>
                        <p class="panel-subtitle">AI-corrected content (green = AI changes)</p>
                        <div class="edit-toggle-container">
                            <button id="editToggleBtn" class="edit-toggle" onclick="toggleEditMode()">
                                <span class="edit-toggle-icon">Edit</span>
                            </button>
                            <button id="rerunCheckBtn" class="rerun-btn" onclick="rerunAICheck()">
                                Re-run AI Check
                            </button>
                        </div>
                    </div>
                    <div id="editModeNotice" class="edit-mode-notice">
                        Editing mode active. Make your changes directly in the text below. Green highlights will be recalculated when you finish.
                    </div>
                    <div class="reviewed-content-container">
                        <div id="reviewedContentArea" class="reviewed-content-area">
                            <!-- AI-corrected content with highlights will appear here -->
                        </div>
                    </div>
                    <div id="originalMenuDisplay" style="display: none;"></div>
                </div>

                <div class="step2-right-panel">
                    <h3 style="text-align: center; margin-bottom: 0.25rem; font-family: var(--font-heading); font-size: 1.1rem; font-weight: 500;">AI Suggestions</h3>
                    <p class="panel-subtitle">Recommended corrections</p>
                    <div id="suggestionsDisplay" class="suggestions-list"></div>
                    <div class="ai-temp-note">AI highlights are temporary. Chef revision redlines are persistent.</div>
                </div>
            </div>
            <div id="persistentPreviewSection" class="persistent-preview">
                <h4>Persistent Revision Preview (What Design Will Receive)</h4>
                <div id="persistentPreviewBody" class="persistent-preview-body"></div>
            </div>

            <div class="btn-container">
                <div id="criticalErrorBanner" class="critical-error-banner">
                    Resolve or override all critical errors before submitting.
                </div>
                <button id="submitBtn" class="btn btn-success" onclick="submitMenu()">
                    Submit Menu for Review
                </button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Menu View Modal -->
    <div id="fullscreenModal" class="fullscreen-modal" onclick="closeFullscreenIfBackdrop(event)">
        <div class="fullscreen-content" onclick="event.stopPropagation()">
            <div class="fullscreen-header">
                <h3>Full Menu View</h3>
                <button class="fullscreen-close" onclick="closeFullscreenView()">&times;</button>
            </div>
            <div class="fullscreen-body" id="fullscreenBody">
                <!-- Pages will be inserted here dynamically -->
            </div>
            <div class="fullscreen-footer">
                <button class="page-btn" id="prevPageBtn" onclick="changePageGroup(-1)">Previous</button>
                <span class="page-indicator" id="pageIndicator">Pages 1-3 of 3</span>
                <button class="page-btn" id="nextPageBtn" onclick="changePageGroup(1)">Next</button>
            </div>
        </div>
    </div>

    <script>
        let aiCheckResults = null;
        let quill = null;
        let isEditMode = false;
        let aiChanges = [];
        let originalAiCorrectedText = '';
        let criticalErrorOverrides = {};
        let submissionMode = 'new';
        let revisionSearchDebounce = null;
        let revisionSearchResults = [];
        let revisionBaseSubmissionId = null;
        let revisionSource = 'database';
        let revisionBaselineDocPath = '';
        let revisionBaselineFileName = '';
        let baseApprovedMenuContent = '';
        let persistentDiffSummary = { insertions: 0, deletions: 0 };
        let persistentPreviewUpdateTimer = null;

        document.addEventListener('DOMContentLoaded', function() {
            quill = new Quill('#menuEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'align': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Paste your menu content here...'
            });

            const menuContainer = document.querySelector('.menu-input-container');
            const exampleContent = document.querySelector('.example-content');

            if (menuContainer && exampleContent) {
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const menuHeight = entry.contentRect.height;
                        const allergensSection = document.querySelector('.allergens-section');
                        const allergensHeight = allergensSection ? allergensSection.offsetHeight : 80;
                        exampleContent.style.minHeight = (menuHeight + allergensHeight) + 'px';
                    }
                });
                resizeObserver.observe(menuContainer);
            }

            // Handle template type changes for approval hint text
            const templateTypeSelect = document.getElementById('templateType');
            if (templateTypeSelect) {
                templateTypeSelect.addEventListener('change', updateApprovalHint);
                // Initialize on load
                updateApprovalHint();
            }

            // Load recent projects
            loadRecentProjects();
            onSubmissionModeChange();

            // Submitter name keyboard nav + blur dismiss
            const submitterNameInput = document.getElementById('submitterName');
            submitterNameInput.addEventListener('keydown', handleSubmitterKeydown);
            submitterNameInput.addEventListener('blur', function() {
                setTimeout(() => {
                    const dropdown = document.getElementById('submitterDropdown');
                    dropdown.classList.remove('show');
                }, 150);
            });
        });

        function updateApprovalHint() {
            const templateType = document.getElementById('templateType').value;
            const hintEl = document.getElementById('approvalHint');

            if (templateType === 'beverage') {
                hintEl.textContent = 'e.g., Head of Mixology, Bar Director, Regional Director of Operations';
            } else {
                hintEl.textContent = 'e.g., Property GM, Director of F&B, Executive Chef, Chef de Cuisine';
            }
        }

        function onSubmissionModeChange() {
            submissionMode = document.getElementById('submissionModeModification').checked ? 'modification' : 'new';
            const modSection = document.getElementById('modificationSearchSection');
            const recentLoader = document.getElementById('recentProjectLoader');
            const previewSection = document.getElementById('persistentPreviewSection');

            if (submissionMode === 'modification') {
                modSection.classList.add('show');
                recentLoader.style.display = 'none';
                previewSection.classList.add('show');
                onModificationSourceChange();
            } else {
                modSection.classList.remove('show');
                if (recentProjectsData.length > 0) {
                    recentLoader.style.display = 'flex';
                }
                previewSection.classList.remove('show');
                revisionBaseSubmissionId = null;
                revisionSource = 'database';
                revisionBaselineDocPath = '';
                revisionBaselineFileName = '';
                baseApprovedMenuContent = '';
                persistentDiffSummary = { insertions: 0, deletions: 0 };
                const selectedNote = document.getElementById('revisionSelectedNote');
                selectedNote.classList.remove('show');
                selectedNote.textContent = '';
                document.getElementById('submissionSearchResults').innerHTML = '';
            }
        }

        function onModificationSourceChange() {
            const useUpload = document.getElementById('modSourceUpload').checked;
            const dbPanel = document.getElementById('modSourceDatabasePanel');
            const uploadPanel = document.getElementById('modSourceUploadPanel');
            const selectedNote = document.getElementById('revisionSelectedNote');
            revisionSource = useUpload ? 'uploaded_baseline' : 'database';

            if (useUpload) {
                dbPanel.classList.remove('show');
                uploadPanel.classList.add('show');
                revisionBaseSubmissionId = null;
                revisionSearchResults = [];
                document.getElementById('submissionSearchResults').innerHTML = '';
                selectedNote.classList.remove('show');
                selectedNote.textContent = '';
            } else {
                uploadPanel.classList.remove('show');
                dbPanel.classList.add('show');
                revisionBaselineDocPath = '';
                revisionBaselineFileName = '';
                selectedNote.classList.remove('show');
                selectedNote.textContent = '';
            }
        }

        function onSubmissionSearchInput(value) {
            clearTimeout(revisionSearchDebounce);
            const query = value.trim();
            if (query.length < 2) {
                document.getElementById('submissionSearchResults').innerHTML = '';
                revisionSearchResults = [];
                return;
            }
            revisionSearchDebounce = setTimeout(() => searchApprovedSubmissions(query), 250);
        }

        async function searchApprovedSubmissions(query) {
            try {
                const response = await fetch(`/api/submissions/search?q=${encodeURIComponent(query)}&limit=20`);
                const results = await response.json();
                revisionSearchResults = results || [];
                const resultsEl = document.getElementById('submissionSearchResults');

                if (!revisionSearchResults.length) {
                    resultsEl.innerHTML = '<div class="search-result-item">No approved submissions found.</div>';
                    return;
                }

                resultsEl.innerHTML = revisionSearchResults.map((r, idx) => `
                    <div class="search-result-item" onclick="selectRevisionResult(${idx})">
                        <strong>${escapeHtml(r.projectName || '(Untitled)')}</strong> - ${escapeHtml(r.property || 'Unknown Property')}<br>
                        <span style="color: var(--color-text-muted);">ID: ${escapeHtml(r.id)} | Updated: ${new Date(r.updatedAt).toLocaleString()}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to search approved submissions:', error);
                document.getElementById('submissionSearchResults').innerHTML = '<div class="search-result-item">Search failed.</div>';
            }
        }

        function selectRevisionResult(index) {
            const selected = revisionSearchResults[index];
            if (!selected) return;

            revisionBaseSubmissionId = selected.id;
            revisionSource = 'database';
            revisionBaselineDocPath = '';
            revisionBaselineFileName = '';
            baseApprovedMenuContent = selected.approvedMenuContent || '';
            persistentDiffSummary = { insertions: 0, deletions: 0 };

            document.getElementById('projectName').value = selected.projectName || '';
            document.getElementById('property').value = selected.property || '';

            quill.setText(baseApprovedMenuContent || '');
            renderPersistentPreview(baseApprovedMenuContent, baseApprovedMenuContent);

            const selectedNote = document.getElementById('revisionSelectedNote');
            selectedNote.textContent = `Loaded approved baseline: ${selected.projectName || 'Untitled'} (${selected.id})`;
            selectedNote.classList.add('show');
            document.getElementById('submissionSearchResults').innerHTML = '';
            showAlert('Approved baseline loaded. Make modifications and run AI check.', 'success');
        }

        async function uploadBaselineDoc() {
            const input = document.getElementById('baselineDocUpload');
            const btn = document.getElementById('baselineUploadBtn');
            const file = input.files && input.files[0];
            if (!file) {
                showAlert('Choose a .docx baseline file first.', 'error');
                return;
            }

            const form = new FormData();
            form.append('baselineDoc', file);

            btn.disabled = true;
            btn.textContent = 'Extracting...';

            try {
                const response = await fetch('/api/modification/baseline-upload', {
                    method: 'POST',
                    body: form,
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to extract baseline document');
                }

                revisionSource = 'uploaded_baseline';
                revisionBaseSubmissionId = null;
                revisionBaselineDocPath = data.baselineDocPath || '';
                revisionBaselineFileName = data.baselineFileName || file.name;
                baseApprovedMenuContent = data.approvedMenuContent || '';
                persistentDiffSummary = { insertions: 0, deletions: 0 };

                if (data.extractedProject) {
                    if (data.extractedProject.projectName) document.getElementById('projectName').value = data.extractedProject.projectName;
                    if (data.extractedProject.property) document.getElementById('property').value = data.extractedProject.property;
                    if (data.extractedProject.orientation) setSelectValue('orientation', data.extractedProject.orientation);
                }

                quill.setText(baseApprovedMenuContent || '');
                renderPersistentPreview(baseApprovedMenuContent, baseApprovedMenuContent);

                const selectedNote = document.getElementById('revisionSelectedNote');
                selectedNote.textContent = `Loaded uploaded baseline: ${revisionBaselineFileName}`;
                selectedNote.classList.add('show');

                showAlert('Baseline extracted from uploaded approved DOCX.', 'success');
            } catch (error) {
                console.error(error);
                showAlert('Failed to process baseline DOCX: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Extract Baseline';
            }
        }

        // === Submitter Autocomplete ===
        let submitterDebounceTimer = null;
        let submitterResults = [];
        let submitterHighlightIndex = -1;

        function onSubmitterNameInput(value) {
            clearTimeout(submitterDebounceTimer);
            submitterDebounceTimer = setTimeout(() => {
                if (value.trim().length < 2) {
                    document.getElementById('submitterDropdown').classList.remove('show');
                    submitterResults = [];
                    return;
                }
                searchSubmitters(value.trim());
            }, 250);
        }

        async function searchSubmitters(query) {
            try {
                const response = await fetch(`/api/submitter-profiles/search?q=${encodeURIComponent(query)}`);
                const profiles = await response.json();
                submitterResults = profiles;
                submitterHighlightIndex = -1;
                showSubmitterDropdown(profiles, query);
            } catch (err) {
                console.error('Submitter search error:', err);
            }
        }

        function showSubmitterDropdown(profiles, query) {
            const dropdown = document.getElementById('submitterDropdown');
            if (!profiles || profiles.length === 0) {
                dropdown.classList.remove('show');
                return;
            }

            const queryLower = query.toLowerCase();
            dropdown.innerHTML = profiles.map((p, i) => {
                const nameHtml = highlightMatch(p.name, queryLower);
                const detail = [p.email, p.jobTitle].filter(Boolean).join('  ');
                return `<div class="autocomplete-item" data-index="${i}" onmousedown="selectSubmitter(${i})">
                    <div class="ac-name">${nameHtml}</div>
                    ${detail ? `<div class="ac-detail">${escapeHtml(detail)}</div>` : ''}
                </div>`;
            }).join('');

            dropdown.classList.add('show');
        }

        function highlightMatch(text, query) {
            const escaped = escapeHtml(text);
            const queryEscaped = escapeHtml(query);
            const regex = new RegExp(`(${queryEscaped.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escaped.replace(regex, '<span class="ac-match">$1</span>');
        }

        function selectSubmitter(index) {
            const profile = submitterResults[index];
            if (!profile) return;

            document.getElementById('submitterName').value = profile.name;
            document.getElementById('submitterEmail').value = profile.email || '';
            document.getElementById('submitterJobTitle').value = profile.jobTitle || '';
            document.getElementById('submitterDropdown').classList.remove('show');
            submitterResults = [];
            submitterHighlightIndex = -1;
        }

        function handleSubmitterKeydown(e) {
            const dropdown = document.getElementById('submitterDropdown');
            if (!dropdown.classList.contains('show') || submitterResults.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                submitterHighlightIndex = Math.min(submitterHighlightIndex + 1, submitterResults.length - 1);
                updateSubmitterHighlight();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                submitterHighlightIndex = Math.max(submitterHighlightIndex - 1, 0);
                updateSubmitterHighlight();
            } else if (e.key === 'Enter' && submitterHighlightIndex >= 0) {
                e.preventDefault();
                selectSubmitter(submitterHighlightIndex);
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
                submitterHighlightIndex = -1;
            }
        }

        function updateSubmitterHighlight() {
            const items = document.querySelectorAll('#submitterDropdown .autocomplete-item');
            items.forEach((item, i) => {
                item.classList.toggle('highlighted', i === submitterHighlightIndex);
            });
            // Scroll highlighted item into view
            if (items[submitterHighlightIndex]) {
                items[submitterHighlightIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        // === Recent Project Loader ===
        let recentProjectsData = [];

        async function loadRecentProjects() {
            try {
                const response = await fetch('/api/recent-projects?limit=20');
                const projects = await response.json();
                recentProjectsData = projects;

                if (projects.length === 0) return;

                const select = document.getElementById('recentProjectSelect');
                projects.forEach((p, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `${p.projectName}  ${p.property}`;
                    select.appendChild(opt);
                });

                if (submissionMode !== 'modification') {
                    document.getElementById('recentProjectLoader').style.display = 'flex';
                }
            } catch (err) {
                console.error('Failed to load recent projects:', err);
            }
        }

        function loadRecentProject(index) {
            if (index < 0 || !recentProjectsData[index]) return;
            const p = recentProjectsData[index];

            document.getElementById('projectName').value = p.projectName || '';
            document.getElementById('property').value = p.property || '';
            document.getElementById('hotelName').value = p.hotelName || '';
            document.getElementById('cityCountry').value = p.cityCountry || '';

            setSelectValue('orientation', p.orientation);
            setSelectValue('menuType', p.menuType);
            setSelectValue('templateType', p.templateType);
            setSelectValue('assetType', p.assetType);

            // Show the right conditional fields
            toggleAssetFields();

            // Populate dimension fields based on asset type
            if (p.assetType === 'PRINT') {
                document.getElementById('widthPrint').value = p.width || '';
                document.getElementById('heightPrint').value = p.height || '';
                setSelectValue('cropMarks', p.cropMarks || 'no');
                setSelectValue('bleedMarks', p.bleedMarks || 'no');
                setSelectValue('fileSizeLimit', p.fileSizeLimit || 'no');
                toggleFileSizeLimit();
                document.getElementById('fileSizeLimitMb').value = p.fileSizeLimitMb || '';
                document.getElementById('fileDeliveryNotes').value = p.fileDeliveryNotes || '';
            } else if (p.assetType === 'DIGITAL') {
                document.getElementById('widthDigital').value = p.width || '';
                document.getElementById('heightDigital').value = p.height || '';
            }

            // Dispatch change event on templateType to update approval hints
            document.getElementById('templateType').dispatchEvent(new Event('change'));
        }

        function toggleAssetFields() {
            const assetType = document.getElementById('assetType').value;
            const printFields = document.getElementById('printFields');
            const digitalFields = document.getElementById('digitalFields');

            if (assetType === 'PRINT') {
                printFields.classList.remove('hidden');
                digitalFields.classList.add('hidden');
                // Clear digital fields
                document.getElementById('widthDigital').value = '';
                document.getElementById('heightDigital').value = '';
            } else if (assetType === 'DIGITAL') {
                digitalFields.classList.remove('hidden');
                printFields.classList.add('hidden');
                // Clear print fields
                document.getElementById('widthPrint').value = '';
                document.getElementById('heightPrint').value = '';
                document.getElementById('cropMarks').value = 'no';
                document.getElementById('bleedMarks').value = 'no';
                document.getElementById('fileSizeLimit').value = 'no';
                document.getElementById('fileSizeLimitMb').value = '';
                document.getElementById('fileDeliveryNotes').value = '';
                document.getElementById('fileSizeLimitMbGroup').classList.add('hidden');
            } else {
                printFields.classList.add('hidden');
                digitalFields.classList.add('hidden');
            }
        }

        function toggleFileSizeLimit() {
            const fileSizeLimit = document.getElementById('fileSizeLimit').value;
            const mbGroup = document.getElementById('fileSizeLimitMbGroup');
            if (fileSizeLimit === 'yes') {
                mbGroup.classList.remove('hidden');
            } else {
                mbGroup.classList.add('hidden');
                document.getElementById('fileSizeLimitMb').value = '';
            }
        }

        function setSelectValue(id, value) {
            const select = document.getElementById(id);
            if (!select || !value) return;

            // Try exact match first
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === value) {
                    select.selectedIndex = i;
                    return;
                }
            }
            // Case-insensitive fallback
            const valueLower = value.toLowerCase();
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value.toLowerCase() === valueLower) {
                    select.selectedIndex = i;
                    return;
                }
            }
        }

        function toggleAdditionalApproval() {
            const additionalGroup = document.getElementById('additionalApprovalGroup');
            const addBtn = document.getElementById('addApprovalBtn');

            if (additionalGroup.classList.contains('hidden')) {
                additionalGroup.classList.remove('hidden');
                addBtn.textContent = '- Remove Additional Approver';
            } else {
                additionalGroup.classList.add('hidden');
                addBtn.textContent = '+ Add Additional Approver';
                // Clear the additional fields
                document.getElementById('approval2').value = '';
                document.getElementById('approver2Name').value = '';
                document.getElementById('approver2Position').value = '';
            }
        }

        let fullscreenPages = [];
        let fsCurrentGroup = 0;
        const FULLSCREEN_PAGES_PER_VIEW = 2;

        function openFullscreenView() {
            const menuContent = quill.root.innerHTML;
            if (!menuContent || quill.getText().trim() === '') {
                showAlert('Please enter menu content first', 'error');
                return;
            }

            document.getElementById('fullscreenModal').classList.add('show');
            document.body.style.overflow = 'hidden';

            const lines = quill.getText().split('\n');
            fullscreenPages = paginateByMeasurement(lines);

            if (fullscreenPages.length === 0) {
                fullscreenPages = [quill.getText()];
            }

            fsCurrentGroup = 0;
            renderFullscreenPages();
            updateFullscreenControls();
        }

        function paginateByMeasurement(lines) {
            const body = document.getElementById('fullscreenBody');
            const pages = [];

            const measurePage = document.createElement('div');
            measurePage.style.cssText = `
                position: absolute;
                visibility: hidden;
                background: white;
                width: 520px;
                padding: 24px 32px 40px 32px;
                font-family: Calibri, sans-serif;
                font-size: 7.5pt;
                line-height: 1.25;
                text-align: center;
            `;
            body.appendChild(measurePage);

            const pageHeight = body.clientHeight - 30;
            const paddingTop = 24;
            const paddingBottom = 40;
            const pageNumberSpace = 25;
            const maxContentHeight = pageHeight - paddingTop - paddingBottom - pageNumberSpace;

            let currentPageLines = [];
            let lineIndex = 0;

            while (lineIndex < lines.length) {
                currentPageLines.push(lines[lineIndex]);

                measurePage.innerHTML = currentPageLines
                    .map(line => {
                        if (!line.trim()) return '<p>&nbsp;</p>';
                        return `<p>${escapeHtml(line)}</p>`;
                    })
                    .join('');

                const contentHeight = measurePage.scrollHeight;

                if (contentHeight > maxContentHeight && currentPageLines.length > 1) {
                    currentPageLines.pop();
                    pages.push(currentPageLines.join('\n'));
                    currentPageLines = [];
                } else {
                    lineIndex++;
                }
            }

            if (currentPageLines.length > 0) {
                pages.push(currentPageLines.join('\n'));
            }

            body.removeChild(measurePage);
            return pages;
        }

        function closeFullscreenView() {
            document.getElementById('fullscreenModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeFullscreenIfBackdrop(event) {
            if (event.target.id === 'fullscreenModal') {
                closeFullscreenView();
            }
        }

        function renderFullscreenPages() {
            const body = document.getElementById('fullscreenBody');
            body.innerHTML = '';

            const startIdx = fsCurrentGroup * FULLSCREEN_PAGES_PER_VIEW;
            const endIdx = Math.min(startIdx + FULLSCREEN_PAGES_PER_VIEW, fullscreenPages.length);

            for (let i = startIdx; i < endIdx; i++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'fullscreen-page';

                const content = fullscreenPages[i] || '';
                const formattedContent = content
                    .split('\n')
                    .map(line => {
                        if (!line.trim()) return '<p>&nbsp;</p>';
                        if (line.trim().toUpperCase() === line.trim() && line.trim().length < 30) {
                            return `<p><strong>${escapeHtml(line)}</strong></p>`;
                        }
                        return `<p>${escapeHtml(line)}</p>`;
                    })
                    .join('');

                pageDiv.innerHTML = formattedContent;

                const pageNum = document.createElement('div');
                pageNum.className = 'fullscreen-page-number';
                pageNum.textContent = `Page ${i + 1}`;
                pageDiv.appendChild(pageNum);

                body.appendChild(pageDiv);
            }
        }

        function updateFullscreenControls() {
            const totalPages = fullscreenPages.length;
            const totalGroups = Math.ceil(totalPages / FULLSCREEN_PAGES_PER_VIEW);
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const indicator = document.getElementById('pageIndicator');

            const startPage = fsCurrentGroup * FULLSCREEN_PAGES_PER_VIEW + 1;
            const endPage = Math.min(startPage + FULLSCREEN_PAGES_PER_VIEW - 1, totalPages);

            prevBtn.disabled = fsCurrentGroup === 0;
            nextBtn.disabled = fsCurrentGroup >= totalGroups - 1;

            indicator.textContent = `Pages ${startPage}-${endPage} of ${totalPages}`;
        }

        function changePageGroup(delta) {
            const totalGroups = Math.ceil(fullscreenPages.length / FULLSCREEN_PAGES_PER_VIEW);
            const newGroup = fsCurrentGroup + delta;
            if (newGroup >= 0 && newGroup < totalGroups) {
                fsCurrentGroup = newGroup;
                renderFullscreenPages();
                updateFullscreenControls();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreenView();
            }
        });

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function validateStep1() {
            const submitterName = document.getElementById('submitterName').value.trim();
            const submitterEmail = document.getElementById('submitterEmail').value.trim();
            const submitterJobTitle = document.getElementById('submitterJobTitle').value.trim();
            const projectName = document.getElementById('projectName').value.trim();
            const property = document.getElementById('property').value.trim();
            const orientation = document.getElementById('orientation').value;
            const menuType = document.getElementById('menuType').value;
            const templateType = document.getElementById('templateType').value;
            const dateNeeded = document.getElementById('dateNeeded').value;
            const cityCountry = document.getElementById('cityCountry').value.trim();
            const assetType = document.getElementById('assetType').value;
            const menuContent = quill.getText().trim();
            const width = assetType === 'PRINT'
                ? document.getElementById('widthPrint').value.trim()
                : document.getElementById('widthDigital').value.trim();
            const height = assetType === 'PRINT'
                ? document.getElementById('heightPrint').value.trim()
                : document.getElementById('heightDigital').value.trim();

            if (!submitterName || !submitterEmail || !submitterJobTitle) {
                showAlert('Please fill in all submitter information fields', 'error');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return false;
            }

            if (!submitterEmail.includes('@')) {
                showAlert('Please enter a valid email address', 'error');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return false;
            }

            if (!projectName || !property || !width || !height || !orientation || !menuType || !templateType || !dateNeeded || !cityCountry || !assetType || !menuContent) {
                showAlert('Please fill in all required fields', 'error');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return false;
            }

            // Validate required approval
            const approval1 = document.getElementById('approval1').value;
            const approver1Name = document.getElementById('approver1Name').value.trim();
            const approver1Position = document.getElementById('approver1Position').value.trim();

            if (!approval1 || !approver1Name || !approver1Position) {
                showAlert('Please complete the required approval fields', 'error');
                document.getElementById('approvalsCard').scrollIntoView({ behavior: 'smooth' });
                return false;
            }

            if (approval1 !== 'yes') {
                showAlert('Approval is required before submission', 'error');
                document.getElementById('approvalsCard').scrollIntoView({ behavior: 'smooth' });
                return false;
            }

            return true;
        }

        async function runBasicCheck() {
            if (!validateStep1()) return;
            if (submissionMode === 'modification' && !revisionBaseSubmissionId && !revisionBaselineDocPath) {
                showAlert('Select a previous approved submission or upload an approved baseline DOCX first.', 'error');
                return;
            }

            const btn = document.getElementById('runCheckBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Running AI Check...';

            const delta = quill.getContents();
            let menuContent = '';

            delta.ops.forEach((op) => {
                if (typeof op.insert === 'string') {
                    menuContent += op.insert;
                }
            });

            menuContent = menuContent.trim();
            const allergens = document.getElementById('allergensInput').value.trim();
            const menuType = document.getElementById('menuType').value;

            try {
                const response = await fetch('/api/form/basic-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ menuContent, allergens, menuType })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to run AI check');
                }

                aiCheckResults = data;
                showStep2(data);
                showAlert('AI check complete! Review the suggestions below.', 'success');

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error running AI check: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Run Basic AI Check';
            }
        }

        function computeLineDiff(original, corrected) {
            const changes = [];
            const origLines = original.split('\n').map(l => l.trim()).filter(l => l);
            const corrLines = corrected.split('\n').map(l => l.trim()).filter(l => l);
            const origLineSet = new Set(origLines.map(l => normalizeWord(l)));
            const origLineMap = new Map();

            origLines.forEach((line, idx) => {
                const norm = normalizeWord(line);
                if (!origLineMap.has(norm)) {
                    origLineMap.set(norm, []);
                }
                origLineMap.get(norm).push({ line, idx });
            });

            let corrOffset = 0;
            const corrFullLines = corrected.split('\n');

            for (let i = 0; i < corrFullLines.length; i++) {
                const corrLine = corrFullLines[i];
                const corrLineTrimmed = corrLine.trim();

                if (corrLineTrimmed) {
                    const corrNorm = normalizeWord(corrLineTrimmed);

                    if (origLineSet.has(corrNorm)) {
                        const origMatches = origLineMap.get(corrNorm);
                        if (origMatches && origMatches.length > 0) {
                            const bestMatch = origMatches[0].line;
                            const wordChanges = findWordChanges(bestMatch, corrLineTrimmed, corrOffset + (corrLine.length - corrLine.trimStart().length));
                            changes.push(...wordChanges);
                        }
                    } else {
                        let bestMatch = null;
                        let bestScore = 0;

                        for (const origLine of origLines) {
                            const score = similarityScore(origLine, corrLineTrimmed);
                            if (score > bestScore) {
                                bestScore = score;
                                bestMatch = origLine;
                            }
                        }

                        if (bestMatch && bestScore > 0.5) {
                            const lineStart = corrOffset + (corrLine.length - corrLine.trimStart().length);
                            const wordChanges = findWordChanges(bestMatch, corrLineTrimmed, lineStart);
                            changes.push(...wordChanges);
                        } else if (bestScore <= 0.5) {
                            const lineStart = corrOffset + (corrLine.length - corrLine.trimStart().length);
                            changes.push({
                                start: lineStart,
                                length: corrLineTrimmed.length,
                                word: corrLineTrimmed
                            });
                        }
                    }
                }

                corrOffset += corrLine.length + 1;
            }

            return changes;
        }

        function similarityScore(str1, str2) {
            const words1 = str1.toLowerCase().split(/\s+/).filter(w => w);
            const words2 = str2.toLowerCase().split(/\s+/).filter(w => w);

            if (words1.length === 0 || words2.length === 0) return 0;

            let matches = 0;
            for (const w1 of words1) {
                for (const w2 of words2) {
                    if (wordsAreSimilar(w1, w2)) {
                        matches++;
                        break;
                    }
                }
            }

            return matches / Math.max(words1.length, words2.length);
        }

        function findWordChanges(origLine, corrLine, lineOffset) {
            const changes = [];
            const origWords = origLine.split(/(\s+)/);
            const corrWords = corrLine.split(/(\s+)/);
            const lcs = longestCommonSubsequence(origWords, corrWords);

            let charOffset = lineOffset;

            for (let i = 0; i < corrWords.length; i++) {
                const word = corrWords[i];
                const isCommon = lcs.includes(i);

                if (!isCommon && word.trim()) {
                    changes.push({
                        start: charOffset,
                        length: word.length,
                        word: word
                    });
                }

                charOffset += word.length;
            }

            return changes;
        }

        function normalizeWord(word) {
            return word.toLowerCase()
                .replace(/[$]/g, '')
                .replace(/[.,;:!?'"()\[\]{}]/g, '')
                .replace(/\s+/g, '');
        }

        function wordsAreSimilar(word1, word2) {
            const norm1 = normalizeWord(word1);
            const norm2 = normalizeWord(word2);

            if (norm1 === norm2) return true;
            if (norm1 + 's' === norm2 || norm2 + 's' === norm1) return true;
            if (norm1 + 'es' === norm2 || norm2 + 'es' === norm1) return true;

            if (Math.abs(norm1.length - norm2.length) === 1) {
                const longer = norm1.length > norm2.length ? norm1 : norm2;
                const shorter = norm1.length > norm2.length ? norm2 : norm1;
                if (longer.startsWith(shorter) && longer.endsWith('s')) return true;
            }

            return false;
        }

        function longestCommonSubsequence(origWords, corrWords) {
            const m = origWords.length;
            const n = corrWords.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (wordsAreSimilar(origWords[i - 1], corrWords[j - 1])) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            const commonIndices = [];
            let i = m, j = n;
            while (i > 0 && j > 0) {
                if (wordsAreSimilar(origWords[i - 1], corrWords[j - 1])) {
                    commonIndices.unshift(j - 1);
                    i--;
                    j--;
                } else if (dp[i - 1][j] > dp[i][j - 1]) {
                    i--;
                } else {
                    j--;
                }
            }

            return commonIndices;
        }

        function renderSuggestionCard(suggestion, idx) {
            const isCritical = suggestion.severity === 'critical';
            const confidenceClass = `confidence-${suggestion.confidence}`;
            const criticalClass = isCritical ? 'critical-error' : '';
            const overriddenClass = criticalErrorOverrides[idx] ? 'overridden' : '';

            let badgeHtml = '';
            if (isCritical) {
                badgeHtml = `<span class="severity-badge-critical">CRITICAL</span>`;
            } else {
                badgeHtml = `<span class="confidence-badge ${confidenceClass}">${(suggestion.confidence || 'medium').toUpperCase()}</span>`;
            }

            let overrideBtnHtml = '';
            if (isCritical) {
                const btnText = criticalErrorOverrides[idx] ? 'Undo Override' : 'Override  AI May Be Wrong';
                const btnClass = criticalErrorOverrides[idx] ? 'critical-override-btn overridden' : 'critical-override-btn';
                overrideBtnHtml = `<button class="${btnClass}" onclick="overrideCriticalError(${idx})">${btnText}</button>`;
            }

            return `
                <div class="suggestion-item ${criticalClass} ${overriddenClass}" data-suggestion-index="${idx}">
                    <div class="suggestion-type">
                        ${escapeHtml(suggestion.type)}
                        ${badgeHtml}
                    </div>
                    ${suggestion.menuItem ? `<div style="font-weight: 600; color: var(--color-text); font-size: 0.75rem; margin: 0.25rem 0;">Item: ${escapeHtml(suggestion.menuItem)}</div>` : ''}
                    <div class="suggestion-detail">${escapeHtml(suggestion.description)}</div>
                    <div style="color: var(--color-success); font-size: 0.75rem; margin-top: 0.25rem;"><strong>Recommendation:</strong> ${escapeHtml(suggestion.recommendation)}</div>
                    ${overrideBtnHtml}
                </div>
            `;
        }

        function updateSubmitButtonState() {
            const submitBtn = document.getElementById('submitBtn');
            const banner = document.getElementById('criticalErrorBanner');

            if (!aiCheckResults || !aiCheckResults.suggestions) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('blocked');
                banner.classList.remove('show');
                return;
            }

            const unresolvedCritical = aiCheckResults.suggestions.some((s, idx) =>
                s.severity === 'critical' && !criticalErrorOverrides[idx]
            );

            if (unresolvedCritical) {
                submitBtn.disabled = true;
                submitBtn.classList.add('blocked');
                banner.classList.add('show');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('blocked');
                banner.classList.remove('show');
            }
        }

        function overrideCriticalError(idx) {
            criticalErrorOverrides[idx] = !criticalErrorOverrides[idx];

            // Re-render just the affected card
            const card = document.querySelector(`.suggestion-item[data-suggestion-index="${idx}"]`);
            if (card && aiCheckResults && aiCheckResults.suggestions[idx]) {
                const newCard = document.createElement('div');
                newCard.innerHTML = renderSuggestionCard(aiCheckResults.suggestions[idx], idx);
                card.replaceWith(newCard.firstElementChild);
            }

            updateSubmitButtonState();
        }

        async function rerunAICheck() {
            const rerunBtn = document.getElementById('rerunCheckBtn');
            rerunBtn.disabled = true;
            rerunBtn.textContent = 'Re-running...';

            // Get current edited text from the reviewed content area
            const reviewedArea = document.getElementById('reviewedContentArea');
            const menuContent = (reviewedArea.innerText || reviewedArea.textContent).trim();
            const allergens = document.getElementById('allergensInput').value.trim();
            const menuType = document.getElementById('menuType').value;

            try {
                const response = await fetch('/api/form/basic-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ menuContent, allergens, menuType })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to run AI check');
                }

                aiCheckResults = data;
                criticalErrorOverrides = {};

                // Re-render step 2 with new results
                showStep2(data);
                showAlert('AI check re-run complete! Review updated suggestions.', 'success');

            } catch (error) {
                console.error('Error re-running check:', error);
                showAlert('Error re-running AI check: ' + error.message, 'error');
            } finally {
                rerunBtn.disabled = false;
                rerunBtn.textContent = 'Re-run AI Check';
            }
        }

        function showStep2(results) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');

            // Reset critical error overrides
            criticalErrorOverrides = {};

            // Populate read-only submitter fields
            document.getElementById('step2SubmitterName').value = document.getElementById('submitterName').value;
            document.getElementById('step2SubmitterEmail').value = document.getElementById('submitterEmail').value;
            document.getElementById('step2SubmitterJobTitle').value = document.getElementById('submitterJobTitle').value;

            // Populate read-only project detail fields
            document.getElementById('step2ProjectName').value = document.getElementById('projectName').value;
            document.getElementById('step2Property').value = document.getElementById('property').value;
            const menuTypeSelect = document.getElementById('menuType');
            document.getElementById('step2MenuType').value = menuTypeSelect.options[menuTypeSelect.selectedIndex].text;
            const templateTypeSelect = document.getElementById('templateType');
            document.getElementById('step2TemplateType').value = templateTypeSelect.options[templateTypeSelect.selectedIndex].text;
            document.getElementById('step2HotelName').value = document.getElementById('hotelName').value || '(none)';
            document.getElementById('step2CityCountry').value = document.getElementById('cityCountry').value;
            document.getElementById('step2DateNeeded').value = document.getElementById('dateNeeded').value;
            const assetTypeSelect = document.getElementById('assetType');
            document.getElementById('step2AssetType').value = assetTypeSelect.options[assetTypeSelect.selectedIndex].text;
            document.getElementById('step2Orientation').value = document.getElementById('orientation').value;

            // Populate dimensions and print-specific fields
            const assetTypeVal = document.getElementById('assetType').value;
            if (assetTypeVal === 'PRINT') {
                const w = document.getElementById('widthPrint').value;
                const h = document.getElementById('heightPrint').value;
                document.getElementById('step2Dimensions').value = `${w} x ${h} inches`;
                // Show print-specific read-only fields
                document.getElementById('step2CropMarksGroup').classList.remove('hidden');
                document.getElementById('step2BleedMarksGroup').classList.remove('hidden');
                document.getElementById('step2FileSizeLimitGroup').classList.remove('hidden');
                document.getElementById('step2CropMarks').value = document.getElementById('cropMarks').value === 'yes' ? 'Yes' : 'No';
                document.getElementById('step2BleedMarks').value = document.getElementById('bleedMarks').value === 'yes' ? 'Yes' : 'No';
                const fsl = document.getElementById('fileSizeLimit').value;
                const fslMb = document.getElementById('fileSizeLimitMb').value;
                document.getElementById('step2FileSizeLimit').value = fsl === 'yes' ? `Yes (${fslMb} MB)` : 'No';
                const deliveryNotes = document.getElementById('fileDeliveryNotes').value.trim();
                if (deliveryNotes) {
                    document.getElementById('step2FileDeliveryNotesGroup').classList.remove('hidden');
                    document.getElementById('step2FileDeliveryNotes').value = deliveryNotes;
                } else {
                    document.getElementById('step2FileDeliveryNotesGroup').classList.add('hidden');
                }
            } else {
                const w = document.getElementById('widthDigital').value;
                const h = document.getElementById('heightDigital').value;
                document.getElementById('step2Dimensions').value = `${w} x ${h} pixels`;
                // Hide print-specific read-only fields
                document.getElementById('step2CropMarksGroup').classList.add('hidden');
                document.getElementById('step2BleedMarksGroup').classList.add('hidden');
                document.getElementById('step2FileSizeLimitGroup').classList.add('hidden');
                document.getElementById('step2FileDeliveryNotesGroup').classList.add('hidden');
            }

            const originalText = results.originalMenu;
            const correctedText = results.correctedMenu;
            const hasChanges = results.hasChanges;

            quill.setText(correctedText);

            if (hasChanges) {
                const changes = computeLineDiff(originalText, correctedText);

                aiChanges = changes.map(change => ({
                    start: change.start,
                    length: change.length,
                    word: change.word
                }));
                originalAiCorrectedText = correctedText;

                changes.forEach(change => {
                    quill.formatText(change.start, change.length, {
                        background: 'rgba(74, 124, 89, 0.2)'
                    });
                });
            } else {
                aiChanges = [];
                originalAiCorrectedText = correctedText;
            }

            // Display the reviewed content with highlights
            displayReviewedContent(quill.root.innerHTML);
            renderPersistentPreview(baseApprovedMenuContent || originalText, correctedText);

            const suggestionsDisplay = document.getElementById('suggestionsDisplay');

            // Sort suggestions: critical first, then normal
            let sortedSuggestions = [];
            if (results.suggestions && results.suggestions.length > 0) {
                sortedSuggestions = [...results.suggestions].sort((a, b) => {
                    if (a.severity === 'critical' && b.severity !== 'critical') return -1;
                    if (a.severity !== 'critical' && b.severity === 'critical') return 1;
                    return 0;
                });
                // Update the results.suggestions to match sorted order for index tracking
                results.suggestions = sortedSuggestions;
            }

            if (hasChanges) {
                let html = `
                    <div class="suggestion-item" style="border-left: 3px solid var(--color-success); background: rgba(74, 124, 89, 0.05);">
                        <div class="suggestion-type" style="color: var(--color-success);">Auto-Corrected</div>
                        <div class="suggestion-detail" style="color: var(--color-success);">
                            High-confidence spelling and grammar corrections have been automatically applied.
                            Green highlights show the changes.
                        </div>
                    </div>
                `;

                if (sortedSuggestions.length > 0) {
                    html += sortedSuggestions.map((suggestion, idx) => renderSuggestionCard(suggestion, idx)).join('');
                }

                suggestionsDisplay.innerHTML = html;
                showAlert('Auto-corrections applied! Green highlights show the changes.', 'success');
            } else if (sortedSuggestions.length > 0) {
                suggestionsDisplay.innerHTML = sortedSuggestions.map((suggestion, idx) => renderSuggestionCard(suggestion, idx)).join('');
            } else {
                suggestionsDisplay.innerHTML = `
                    <div class="suggestion-item" style="border-left: 3px solid var(--color-success);">
                        <div class="suggestion-type" style="color: var(--color-success);">All Clear</div>
                        <div class="suggestion-detail">No issues found. Your menu looks perfect!</div>
                    </div>
                `;
            }

            updateSubmitButtonState();
        }

        async function submitMenu() {
            // Block if unresolved critical errors exist
            if (aiCheckResults && aiCheckResults.suggestions) {
                const unresolvedCritical = aiCheckResults.suggestions.some((s, idx) =>
                    s.severity === 'critical' && !criticalErrorOverrides[idx]
                );
                if (unresolvedCritical) {
                    showAlert('Please resolve or override all critical errors before submitting.', 'error');
                    return;
                }
            }

            if (submissionMode === 'modification' && !revisionBaseSubmissionId && !revisionBaselineDocPath) {
                showAlert('Select a previous approved submission or upload an approved baseline DOCX before submitting.', 'error');
                return;
            }

            if (isEditMode) {
                toggleEditMode();
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Submitting...';

            const reviewedArea = document.getElementById('reviewedContentArea');
            const menuContentHtml = reviewedArea.innerHTML;
            const menuContentText = (reviewedArea.innerText || reviewedArea.textContent).trim();

            // Also update the hidden display
            document.getElementById('originalMenuDisplay').innerHTML = menuContentHtml;

            // Collect approval data
            const approvals = [{
                approved: document.getElementById('approval1').value === 'yes',
                name: document.getElementById('approver1Name').value.trim(),
                position: document.getElementById('approver1Position').value.trim()
            }];

            // Check if additional approver was added
            const approval2 = document.getElementById('approval2').value;
            const approver2Name = document.getElementById('approver2Name').value.trim();
            const approver2Position = document.getElementById('approver2Position').value.trim();

            if (approval2 && approver2Name && approver2Position) {
                approvals.push({
                    approved: approval2 === 'yes',
                    name: approver2Name,
                    position: approver2Position
                });
            }

            // Collect critical error overrides for audit trail
            const criticalOverrides = [];
            if (aiCheckResults && aiCheckResults.suggestions) {
                aiCheckResults.suggestions.forEach((s, idx) => {
                    if (s.severity === 'critical' && criticalErrorOverrides[idx]) {
                        criticalOverrides.push({
                            type: s.type,
                            menuItem: s.menuItem,
                            description: s.description
                        });
                    }
                });
            }

            const assetTypeValue = document.getElementById('assetType').value;
            const isPrint = assetTypeValue === 'PRINT';

            const formData = {
                submitterName: document.getElementById('submitterName').value.trim(),
                submitterEmail: document.getElementById('submitterEmail').value.trim(),
                submitterJobTitle: document.getElementById('submitterJobTitle').value.trim(),
                projectName: document.getElementById('projectName').value.trim(),
                property: document.getElementById('property').value.trim(),
                width: isPrint ? document.getElementById('widthPrint').value.trim() : document.getElementById('widthDigital').value.trim(),
                height: isPrint ? document.getElementById('heightPrint').value.trim() : document.getElementById('heightDigital').value.trim(),
                cropMarks: isPrint ? document.getElementById('cropMarks').value : 'no',
                bleedMarks: isPrint ? document.getElementById('bleedMarks').value : 'no',
                fileSizeLimit: isPrint ? document.getElementById('fileSizeLimit').value : 'no',
                fileSizeLimitMb: isPrint ? document.getElementById('fileSizeLimitMb').value.trim() : '',
                fileDeliveryNotes: isPrint ? document.getElementById('fileDeliveryNotes').value.trim() : '',
                orientation: document.getElementById('orientation').value,
                menuType: document.getElementById('menuType').value,
                templateType: document.getElementById('templateType').value,
                dateNeeded: document.getElementById('dateNeeded').value,
                hotelName: document.getElementById('hotelName').value.trim(),
                cityCountry: document.getElementById('cityCountry').value.trim(),
                assetType: assetTypeValue,
                menuContent: menuContentText,
                menuContentHtml: menuContentHtml,
                approvals: approvals,
                criticalOverrides: criticalOverrides,
                submissionMode: submissionMode,
                revisionSource: submissionMode === 'modification' ? revisionSource : null,
                revisionBaseSubmissionId: revisionBaseSubmissionId,
                revisionBaselineDocPath: submissionMode === 'modification' ? revisionBaselineDocPath : '',
                revisionBaselineFileName: submissionMode === 'modification' ? revisionBaselineFileName : '',
                baseApprovedMenuContent: submissionMode === 'modification' ? baseApprovedMenuContent : '',
                chefPersistentDiff: submissionMode === 'modification' ? persistentDiffSummary : null
            };

            try {
                const response = await fetch('/api/form/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to submit menu');
                }

                showAlert('Menu submitted successfully! Redirecting to review page...', 'success');

                setTimeout(() => {
                    window.location.href = `/review/${data.submissionId}`;
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error submitting menu: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Submit Menu for Review';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayReviewedContent(htmlContent) {
            const reviewedArea = document.getElementById('reviewedContentArea');

            // Clean up excessive empty paragraphs that can accumulate
            let cleanedHtml = htmlContent
                // Remove multiple consecutive empty paragraphs
                .replace(/(<p><br><\/p>\s*){2,}/gi, '<p><br></p>')
                // Remove multiple consecutive &nbsp; paragraphs
                .replace(/(<p>&nbsp;<\/p>\s*){2,}/gi, '<p><br></p>')
                // Remove empty paragraphs with just whitespace
                .replace(/<p>\s*<\/p>/gi, '<p><br></p>');

            reviewedArea.innerHTML = cleanedHtml;
            document.getElementById('originalMenuDisplay').innerHTML = cleanedHtml;
        }

        function toggleEditMode() {
            const editBtn = document.getElementById('editToggleBtn');
            const editNotice = document.getElementById('editModeNotice');
            const reviewedArea = document.getElementById('reviewedContentArea');

            isEditMode = !isEditMode;

            if (isEditMode) {
                editBtn.classList.add('active');
                editBtn.innerHTML = '<span class="edit-toggle-icon">Done Editing</span>';
                editNotice.classList.add('show');
                reviewedArea.classList.add('editable');
                reviewedArea.contentEditable = 'true';
                reviewedArea.focus();
                reviewedArea.addEventListener('input', handleReviewedAreaInput);
                // Hide re-run button while editing
                document.getElementById('rerunCheckBtn').classList.remove('show');
            } else {
                editBtn.classList.remove('active');
                editBtn.innerHTML = '<span class="edit-toggle-icon">Edit</span>';
                editNotice.classList.remove('show');
                reviewedArea.classList.remove('editable');
                reviewedArea.contentEditable = 'false';
                reviewedArea.removeEventListener('input', handleReviewedAreaInput);
                recalculateHighlights();
                // Show re-run button after editing
                document.getElementById('rerunCheckBtn').classList.add('show');
            }
        }

        function extractCleanTextFromReviewedArea(element) {
            const paragraphs = element.querySelectorAll('p');

            if (paragraphs.length === 0) {
                return (element.textContent || '').trim()
                    .split(/\n+/)
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');
            }

            const lines = [];
            paragraphs.forEach(p => {
                const text = (p.textContent || '').trim();
                if (text && text !== '\u00A0' && text.length > 0) {
                    lines.push(text);
                }
            });
            return lines.join('\n');
        }

        function handleReviewedAreaInput() {
            if (submissionMode !== 'modification') return;
            const reviewedArea = document.getElementById('reviewedContentArea');
            clearTimeout(persistentPreviewUpdateTimer);
            persistentPreviewUpdateTimer = setTimeout(() => {
                const currentText = extractCleanTextFromReviewedArea(reviewedArea);
                renderPersistentPreview(baseApprovedMenuContent || (aiCheckResults?.originalMenu || ''), currentText);
            }, 120);
        }

        function tokenizeForDiff(text) {
            return (text || '').split(/(\s+)/).filter(token => token.length > 0);
        }

        function normalizeToken(token) {
            return token.toLowerCase().replace(/[^\p{L}\p{N}$|.-]/gu, '');
        }

        function buildTokenLcs(baseTokens, revisedTokens) {
            const m = baseTokens.length;
            const n = revisedTokens.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (normalizeToken(baseTokens[i - 1]) === normalizeToken(revisedTokens[j - 1])) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            const commonBase = new Set();
            const commonRev = new Set();
            let i = m;
            let j = n;
            while (i > 0 && j > 0) {
                if (normalizeToken(baseTokens[i - 1]) === normalizeToken(revisedTokens[j - 1])) {
                    commonBase.add(i - 1);
                    commonRev.add(j - 1);
                    i--;
                    j--;
                } else if (dp[i - 1][j] >= dp[i][j - 1]) {
                    i--;
                } else {
                    j--;
                }
            }

            return { commonBase, commonRev };
        }

        function renderPersistentPreview(baseText, revisedText) {
            const previewSection = document.getElementById('persistentPreviewSection');
            const previewBody = document.getElementById('persistentPreviewBody');

            if (submissionMode !== 'modification') {
                previewSection.classList.remove('show');
                previewBody.innerHTML = '';
                return;
            }

            previewSection.classList.add('show');
            const baseTokens = tokenizeForDiff(baseText);
            const revisedTokens = tokenizeForDiff(revisedText);
            const lcs = buildTokenLcs(baseTokens, revisedTokens);

            let insertions = 0;
            let deletions = 0;
            let html = '';

            for (let i = 0; i < baseTokens.length; i++) {
                if (!lcs.commonBase.has(i) && baseTokens[i].trim()) {
                    html += `<span class="persistent-del">${escapeHtml(baseTokens[i])}</span>`;
                    deletions++;
                } else {
                    html += escapeHtml(baseTokens[i]);
                }
            }

            html += '\n\n';

            for (let i = 0; i < revisedTokens.length; i++) {
                if (!lcs.commonRev.has(i) && revisedTokens[i].trim()) {
                    html += `<span class="persistent-ins">${escapeHtml(revisedTokens[i])}</span>`;
                    insertions++;
                } else {
                    html += escapeHtml(revisedTokens[i]);
                }
            }

            persistentDiffSummary = { insertions, deletions };
            previewBody.innerHTML = html;
        }

        function recalculateHighlights() {
            const reviewedArea = document.getElementById('reviewedContentArea');

            // Extract clean text from the edited content
            const currentText = extractCleanTextFromReviewedArea(reviewedArea);

            quill.setText(currentText);

            const currentChanges = computeLineDiff(aiCheckResults.originalMenu, currentText);
            const preservedChanges = [];

            aiChanges.forEach(aiChange => {
                const changeStillPresent = currentChanges.some(currentChange => {
                    return currentChange.word === aiChange.word &&
                           Math.abs(currentChange.start - aiChange.start) < 5;
                });

                const textAtPosition = currentText.substring(
                    Math.max(0, aiChange.start - 10),
                    aiChange.start + aiChange.length + 10
                );

                if (changeStillPresent || textAtPosition.includes(aiChange.word)) {
                    const newPosition = findWordPosition(currentText, aiChange.word, aiChange.start);
                    if (newPosition !== -1) {
                        preservedChanges.push({
                            start: newPosition,
                            length: aiChange.length,
                            word: aiChange.word
                        });
                    }
                }
            });

            preservedChanges.forEach(change => {
                quill.formatText(change.start, change.length, {
                    background: 'rgba(74, 124, 89, 0.2)'
                });
            });

            displayReviewedContent(quill.root.innerHTML);
            renderPersistentPreview(baseApprovedMenuContent || aiCheckResults.originalMenu, currentText);
        }

        function findWordPosition(text, word, expectedPosition) {
            const searchStart = Math.max(0, expectedPosition - 50);
            const searchEnd = Math.min(text.length, expectedPosition + 50);
            const searchArea = text.substring(searchStart, searchEnd);
            const localIndex = searchArea.indexOf(word);

            if (localIndex !== -1) {
                return searchStart + localIndex;
            }

            return text.indexOf(word);
        }

    </script>
</body>
</html>
